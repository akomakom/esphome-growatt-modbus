##############################################
# Append this to your esphome yaml file in ESPHome Builder:
##############################################

substitutions:
  # Sensor update_interval for most sensors: 
  polling_rate: "10s"  
  # For today and lifetime counters, only update every n+1 iterations
  # To reduce modbus load (these values don't change frequently)
  # EG 5 == 60s
  skip_count_for_counters: 5 
  # Same for temperature sensors, values tend not to change that frequently
  skip_count_for_temperature: 5

# UART Configuration for RS485.  SPH 10000TL-HU-US uses 115200 baud
# Change pins for your wiring setup
uart:
  id: mod_uart
  tx_pin: GPIO6
  rx_pin: GPIO7
  baud_rate: 115200
  stop_bits: 1

# Modbus Configuration
modbus:
  id: mod_bus
  uart_id: mod_uart
  send_wait_time: 20ms  #Reducing  load on modbus to minimize errors

# Modbus Controller
modbus_controller:
  - id: growatt_sph
    address: 0x01
    modbus_id: mod_bus
    setup_priority: -10
    command_throttle: 30ms  # Increased from 30ms to give inverter more time
    update_interval: ${polling_rate}    # See substitutions above

# Text Sensors for Status
text_sensor:
  # Inverter Status (Address 0)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 0
    name: "Inverter Status"
    register_type: read
    raw_encode: HEXBYTES
    lambda: |-
      uint16_t value = modbus_controller::word_from_hex_str(x, 0);
      switch(value) {
        case 0: return std::string("Waiting");
        case 1: return std::string("Normal");
        case 3: return std::string("Fault");
        default: return std::string("Unknown");
      }

sensor:
# ============================================
# INVERTER STATUS & OPERATION
# ============================================

  # Inverter Status Code (Address 0)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 0
    name: "Inverter Status Code"
    id: inverter_status_code
    register_type: read
    value_type: U_WORD

  # Power Factor (Address 100)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 100
    name: "Power Factor"
    register_type: read
    value_type: U_WORD
    device_class: power_factor
    accuracy_decimals: 3
    filters:
      - multiply: 0.0001

# ============================================
# PV SOLAR STRINGS - INSTANTANEOUS
# ============================================

  # Total PV Input Power (Address 1-2)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1
    name: "PV Input Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 1 - Voltage (Address 3)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 3
    name: "PV1 Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 1 - Current (Address 4)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 4
    name: "PV1 Current"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV String 1 - Power (Address 5-6)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 5
    name: "PV1 Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 2 - Voltage (Address 7)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 7
    name: "PV2 Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 2 - Current (Address 8)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 8
    name: "PV2 Current"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV String 2 - Power (Address 9-10)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 9
    name: "PV2 Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 3 - Voltage (Address 11)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 11
    name: "PV3 Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 3 - Current (Address 12)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 12
    name: "PV3 Current"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV String 3 - Power (Address 13-14)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 13
    name: "PV3 Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

# ============================================
# INVERTER AC OUTPUT
# ============================================

  # AC Output Power Total (Address 35-36)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 35
    name: "AC Output Power"
    id: ac_output_power
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1
        # Reject spurious values from Modbus errors, sometimes reads >400 million
      - clamp:
          min_value: 0
          max_value: 20000
          ignore_out_of_range: true

  # Grid Frequency (Address 37)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 37
    name: "Grid Frequency"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    filters:
      - multiply: 0.01

  # Grid Voltage L1 (Address 38)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 38
    name: "Grid Voltage L1"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Current L1 (Address 39)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 39
    name: "Grid Current L1"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Power L1 (Address 40-41)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 40
    name: "Grid Power L1"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "VA"
    device_class: apparent_power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Grid Voltage L2 (Address 42)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 42
    name: "Grid Voltage L2"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Current L2 (Address 43)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 43
    name: "Grid Current L2"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Power L2 (Address 44-45)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 44
    name: "Grid Power L2"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "VA"
    device_class: apparent_power
    state_class: measurement
    filters:
      - multiply: 0.1

# ============================================
# INVERTER TEMPERATURES
# ============================================

  # Inverter Temperature (Address 93)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 93
    name: "Inverter Temperature"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    skip_updates: ${skip_count_for_temperature}
    filters:
      - multiply: 0.1
      - clamp:
          min_value: -40
          max_value: 200
          ignore_out_of_range: true
      - median:  
          window_size: 3 # Ignore zero in 11, 0, 11 sequence
      - delta: 0.5 # tune out jitter to save storage.
          
  # IPM Temperature (Address 94)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 94
    name: "IPM Temperature"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    skip_updates: ${skip_count_for_temperature}
    filters:
      - multiply: 0.1
      - clamp:
          min_value: -40
          max_value: 200
          ignore_out_of_range: true
      - median:  
          window_size: 3 # Ignore zero in 11, 0, 11 sequence
      - delta: 0.5 # tune out jitter to save storage.

  # Boost Temperature (Address 95)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 95
    name: "Boost Temperature"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    skip_updates: ${skip_count_for_temperature}
    filters:
      - multiply: 0.1
      - clamp:
          min_value: -40
          max_value: 200
          ignore_out_of_range: true
      - median:  
          window_size: 3 # Ignore zero in 11, 0, 11 sequence
      - delta: 0.5 # tune out jitter to save storage.          

# ============================================
# BATTERY
# ============================================

  # Battery Voltage (Address 1013)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1013
    name: "Battery Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
      # Reject spurious values from Modbus errors, sometimes reads >5k
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true          

  # Battery State of Charge (Address 1014)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1014
    name: "Battery SOC"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    filters:
      # Reject spurious values from Modbus errors
      # Battery SOC should be 0-100%, reject anything outside this range
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true
      - median:  
          window_size: 3 # Ignore 54%, 0%, 54% sequence for bad readings:
      - delta: 0.5 # tune out jitter to save storage.

  # Battery Discharge Power (Address 1009-1010)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1009
    name: "Battery Discharge Power"
    id: battery_discharge_power
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1
      # Reject spurious values from Modbus errors, somtimes reads >60 million
      - clamp:
          min_value: 0
          max_value: 20000
          ignore_out_of_range: true      

  # Battery Charge Power (Address 1011-1012)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1011
    name: "Battery Charge Power"
    id: battery_charge_power
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1
            # Reject spurious values from Modbus errors
      - clamp:
          min_value: 0
          max_value: 20000
          ignore_out_of_range: true    

  # Battery Temperature (Address 1039-1040)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1039
    name: "Battery Temperature"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_temperature}
    filters:
      - multiply: 0.1
        # Reject spurious values from Modbus errors, sometimes reads >2000F
      - clamp:
          min_value: -40
          max_value: 200
          ignore_out_of_range: true     
      - median:  
          window_size: 3 # Ignore zero in 11, 0, 11 sequence
      - delta: 0.5 # tune out jitter to save storage.
# ============================================
# GRID CT - IMPORT POWER (Pactouser)
# ============================================

  # Grid Import Power L1 (Address 1015-1016)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1015
    name: "Grid Import Power L1"
    id: grid_import_l1
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
        # Reject spurious values from Modbus errors, sometimes reads >100m
      - clamp:
          min_value: 0
          max_value: 100000
          ignore_out_of_range: true       

  # Grid Import Power L2 (Address 1017-1018)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1017
    name: "Grid Import Power L2"
    id: grid_import_l2
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
      # Reject spurious values from Modbus errors, sometimes reads >100m
      - clamp:
          min_value: 0
          max_value: 100000
          ignore_out_of_range: true          

  # Total Grid Import Power (Address 1021-1022)
  ##  This one is always zero, so using Grid Import Power (calculated)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 1021
  #   name: "Grid Import Power Total (Modbus)"
  #   id: grid_import_total
  #   register_type: read
  #   value_type: S_DWORD
  #   unit_of_measurement: "W"
  #   device_class: power
  #   state_class: measurement
  #   accuracy_decimals: 1
  #   filters:
  #     - multiply: 0.1
  #     # Reject spurious values from Modbus errors, sometimes reads >100m
  #     - clamp:
  #         min_value: 0
  #         max_value: 100000
  #         ignore_out_of_range: true

# ============================================
# GRID CT - EXPORT POWER (Pactogrid)
# ============================================

  # Grid Export Power L1 (Address 1023-1024)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1023
    name: "Grid Export Power L1"
    id: grid_export_l1
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1
      # Reject spurious values from Modbus errors, sometimes reads >100m
      - clamp:
          min_value: 0
          max_value: 100000
          ignore_out_of_range: true        

  # Grid Export Power L2 (Address 1025-1026)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1025
    name: "Grid Export Power L2"
    id: grid_export_l2
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1
      # Reject spurious values from Modbus errors, sometimes reads >100m
      - clamp:
          min_value: 0
          max_value: 100000
          ignore_out_of_range: true        

  # Total Grid Export Power (Address 1029-1030)
  # This one doesn't seem to work - always returns 0
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 1029
  #   name: "Grid Export Power Total (Modbus)"
  #   id: grid_export_total
  #   register_type: read
  #   value_type: S_DWORD
  #   unit_of_measurement: "W"
  #   device_class: power
  #   state_class: measurement
  #   filters:
  #     - multiply: 0.1

# ============================================
# INVERTER TO LOCAL LOAD POWER (PLocalLoad)
# ============================================

  # Inverter to Load L1 (Address 1031-1032)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1031
    name: "Inverter to Load L1"
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Inverter to Load L2 (Address 1033-1034)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1033
    name: "Inverter to Load L2"
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Total Inverter to Load (Address 1037-1038)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1037
    name: "Inverter to Load Power"
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
      # Reject spurious values from Modbus errors, sometimes reads >40k
      - clamp:
          min_value: 0
          max_value: 20000
          ignore_out_of_range: true  
# ============================================
# CALCULATED SENSORS
# ============================================

  # Calculated Grid Import Total (L1 + L2)
  - platform: template
    name: "Grid Import Power"
    id: grid_import_calculated
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float l1 = id(grid_import_l1).state;
      float l2 = id(grid_import_l2).state;
      if (isnan(l1)) l1 = 0;
      if (isnan(l2)) l2 = 0;
      return l1 + l2;
    update_interval: ${polling_rate}

  # Calculated Grid Export Total (L1 + L2) 
  # because the growatt inverter does not provide a total grid import value (always 0)
  - platform: template
    name: "Grid Export Power"
    id: grid_export_calculated
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float l1 = id(grid_export_l1).state;
      float l2 = id(grid_export_l2).state;
      if (isnan(l1)) l1 = 0;
      if (isnan(l2)) l2 = 0;
      return l1 + l2;
    update_interval: ${polling_rate}

  # Calculated House Load Power
  # Formula: AC Output Power - Grid Export + Grid Import
  - platform: template
    name: "House Load Power"
    id: house_load_power
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float ac_output = id(ac_output_power).state;
      float grid_export = id(grid_export_calculated).state;
      float grid_import = id(grid_import_calculated).state;
      if (isnan(ac_output)) ac_output = 0;
      if (isnan(grid_export)) grid_export = 0;
      if (isnan(grid_import)) grid_import = 0;
      return ac_output - grid_export + grid_import;
    update_interval: ${polling_rate}

  # Net Grid Power (Positive = Import, Negative = Export)
  - platform: template
    name: "Grid Power Net"
    id: grid_power_net
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float import_total = id(grid_import_calculated).state;
      float export_total = id(grid_export_calculated).state;
      if (isnan(import_total)) import_total = 0;
      if (isnan(export_total)) export_total = 0;
      return import_total - export_total;
    update_interval: ${polling_rate}

  # Net Battery Power (Positive = Charging, Negative = Discharging)
  - platform: template
    name: "Battery Power Net"
    id: battery_power_net
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float charge = id(battery_charge_power).state;
      float discharge = id(battery_discharge_power).state;
      if (isnan(charge)) charge = 0;
      if (isnan(discharge)) discharge = 0;
      return charge - discharge;
    update_interval: ${polling_rate}

# ============================================
# ENERGY COUNTERS - DAILY
# ============================================

  # Today AC Production (Address 53-54)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 53
    name: "Today AC Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Today PV Production (Address 1149-1150)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1149
    name: "Today PV Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Today Load Energy from Inverter (Address 1060-1061)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1060
    name: "Today Inverter to Load Energy"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Today Grid Import Energy (Address 1044-1045)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1044
    name: "Today Grid Import"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Today Grid Export Energy (Address 1048-1049)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1048
    name: "Today Grid Export"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Today Battery Charge (Address 1056-1057)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1056
    name: "Today Battery Charge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Today Battery Discharge (Address 1052-1053)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1052
    name: "Today Battery Discharge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

# ============================================
# ENERGY COUNTERS - LIFETIME
# ============================================

  # Total AC Production (Address 55-56)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 55
    name: "Total AC Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Total PV Production (Address 91-92)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 91
    name: "Total PV Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Total Inverter to Load Energy (Address 1046-1047)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1046
    name: "Total Grid Import"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Total Grid Export (Address 1050-1051)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1050
    name: "Total Grid Export"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Total Battery Charge (Address 1058-1059)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1058
    name: "Total Battery Charge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Total Battery Discharge (Address 1054-1055)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1054
    name: "Total Battery Discharge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_count_for_counters}
    filters:
      - multiply: 0.1

  # Self Consumption Energy Total (Address 1143-1144)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1143
    name: "Total Self Consumption"
    id: self_consumption_total
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

# ============================================
# PV STRING ENERGY COUNTERS (Optional)
# ============================================
# Uncomment if you want per-string energy tracking

  # # PV1 Today Energy (Address 59-60)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 59
  #   name: "PV1 Today Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: ${skip_count_for_counters}
  #   filters:
  #     - multiply: 0.1

  # # PV1 Total Energy (Address 61-62)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 61
  #   name: "PV1 Total Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: ${skip_count_for_counters}
  #   filters:
  #     - multiply: 0.1

  # # PV2 Today Energy (Address 63-64)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 63
  #   name: "PV2 Today Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: ${skip_count_for_counters}
  #   filters:
  #     - multiply: 0.1

  # # PV2 Total Energy (Address 65-66)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 65
  #   name: "PV2 Total Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: ${skip_count_for_counters}
  #   filters:
  #     - multiply: 0.1

  # # PV3 Today Energy (Address 67-68)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 67
  #   name: "PV3 Today Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: ${skip_count_for_counters}
  #   filters:
  #     - multiply: 0.1

  # # PV3 Total Energy (Address 69-70)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 69
  #   name: "PV3 Total Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: ${skip_count_for_counters}
  #   filters:
  #     - multiply: 0.1

