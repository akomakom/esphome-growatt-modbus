##############################################
# Append this to your esphome yaml file in ESPHome Builder:
##############################################

# UART Configuration for RS485
uart:
  id: mod_uart
  tx_pin: GPIO6
  rx_pin: GPIO7
  baud_rate: 115200
  stop_bits: 1

# Modbus Configuration
modbus:
  id: mod_bus
  uart_id: mod_uart
  send_wait_time: 20ms

# Modbus Controller
modbus_controller:
  - id: growatt_sph
    address: 0x01
    modbus_id: mod_bus
    setup_priority: -10
    command_throttle: 30ms
    update_interval: 10s

# Text Sensors for Status
text_sensor:
  # Inverter Status (Address 0)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 0
    name: "Inverter Status"
    register_type: read
    raw_encode: HEXBYTES
    lambda: |-
      uint16_t value = modbus_controller::word_from_hex_str(x, 0);
      switch(value) {
        case 0: return std::string("Waiting");
        case 1: return std::string("Normal");
        case 3: return std::string("Fault");
        default: return std::string("Unknown");
      }

sensor:
# ============================================
# INVERTER STATUS & OPERATION
# ============================================

  # Inverter Status Code (Address 0)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 0
    name: "Inverter Status Code"
    id: inverter_status_code
    register_type: read
    value_type: U_WORD

  # Power Factor (Address 100)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 100
    name: "Power Factor"
    register_type: read
    value_type: U_WORD
    device_class: power_factor
    accuracy_decimals: 3
    filters:
      - multiply: 0.0001

# ============================================
# PV SOLAR STRINGS - INSTANTANEOUS
# ============================================

  # Total PV Input Power (Address 1-2)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1
    name: "PV Input Power Total"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 1 - Voltage (Address 3)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 3
    name: "PV1 Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 1 - Current (Address 4)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 4
    name: "PV1 Current"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV String 1 - Power (Address 5-6)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 5
    name: "PV1 Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 2 - Voltage (Address 7)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 7
    name: "PV2 Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 2 - Current (Address 8)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 8
    name: "PV2 Current"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV String 2 - Power (Address 9-10)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 9
    name: "PV2 Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 3 - Voltage (Address 11)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 11
    name: "PV3 Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # PV String 3 - Current (Address 12)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 12
    name: "PV3 Current"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV String 3 - Power (Address 13-14)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 13
    name: "PV3 Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

# ============================================
# INVERTER AC OUTPUT
# ============================================

  # AC Output Power Total (Address 35-36)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 35
    name: "AC Output Power"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Grid Frequency (Address 37)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 37
    name: "Grid Frequency"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    filters:
      - multiply: 0.01

  # Grid Voltage L1 (Address 38)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 38
    name: "Grid Voltage L1"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # Grid Current L1 (Address 39)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 39
    name: "Grid Current L1"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Power L1 (Address 40-41)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 40
    name: "Grid Power L1"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "VA"
    device_class: apparent_power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Grid Voltage L2 (Address 42)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 42
    name: "Grid Voltage L2"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # Grid Current L2 (Address 43)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 43
    name: "Grid Current L2"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Power L2 (Address 44-45)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 44
    name: "Grid Power L2"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "VA"
    device_class: apparent_power
    state_class: measurement
    filters:
      - multiply: 0.1

# ============================================
# INVERTER TEMPERATURES
# ============================================

  # Inverter Temperature (Address 93)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 93
    name: "Inverter Temperature"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    skip_updates: 5
    filters:
      - multiply: 0.1

  # IPM Temperature (Address 94)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 94
    name: "IPM Temperature"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Boost Temperature (Address 95)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 95
    name: "Boost Temperature"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    skip_updates: 5
    filters:
      - multiply: 0.1

# ============================================
# BATTERY
# ============================================

  # Battery Voltage (Address 1013)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1013
    name: "Battery Voltage"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    filters:
      - multiply: 0.1

  # Battery State of Charge (Address 1014)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1014
    name: "Battery SOC"
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    filters:
      # Reject spurious values from Modbus errors
      # Battery SOC should be 0-100%, reject anything outside this range
      - clamp:
          min_value: 0
          max_value: 100
          ignore_out_of_range: true

  # Battery Discharge Power (Address 1009-1010)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1009
    name: "Battery Discharge Power"
    id: battery_discharge_power
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Battery Charge Power (Address 1011-1012)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1011
    name: "Battery Charge Power"
    id: battery_charge_power
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Battery Temperature (Address 1039-1040)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1039
    name: "Battery Temperature"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "째C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

# ============================================
# GRID CT - IMPORT POWER (Pactouser)
# ============================================

  # Grid Import Power L1 (Address 1015-1016)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1015
    name: "Grid Import Power L1"
    id: grid_import_l1
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Import Power L2 (Address 1017-1018)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1017
    name: "Grid Import Power L2"
    id: grid_import_l2
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Total Grid Import Power (Address 1021-1022)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1021
    name: "Grid Import Power"
    id: grid_import_total
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

# ============================================
# GRID CT - EXPORT POWER (Pactogrid)
# ============================================

  # Grid Export Power L1 (Address 1023-1024)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1023
    name: "Grid Export Power L1"
    id: grid_export_l1
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Grid Export Power L2 (Address 1025-1026)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1025
    name: "Grid Export Power L2"
    id: grid_export_l2
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

  # Total Grid Export Power (Address 1029-1030)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1029
    name: "Grid Export Power"
    id: grid_export_total
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    filters:
      - multiply: 0.1

# ============================================
# INVERTER TO LOCAL LOAD POWER (PLocalLoad)
# ============================================

  # Inverter to Load L1 (Address 1031-1032)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1031
    name: "Inverter to Load L1"
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Inverter to Load L2 (Address 1033-1034)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1033
    name: "Inverter to Load L2"
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Total Inverter to Load (Address 1037-1038)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1037
    name: "Inverter to Load Power"
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

# ============================================
# CALCULATED SENSORS
# ============================================

  # Net Grid Power (Positive = Import, Negative = Export)
  - platform: template
    name: "Grid Power Net"
    id: grid_power_net
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float import_total = id(grid_import_total).state;
      float export_total = id(grid_export_total).state;
      if (isnan(import_total)) import_total = 0;
      if (isnan(export_total)) export_total = 0;
      return import_total - export_total;
    update_interval: 10s

  # Net Battery Power (Positive = Charging, Negative = Discharging)
  - platform: template
    name: "Battery Power Net"
    id: battery_power_net
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      float charge = id(battery_charge_power).state;
      float discharge = id(battery_discharge_power).state;
      if (isnan(charge)) charge = 0;
      if (isnan(discharge)) discharge = 0;
      return charge - discharge;
    update_interval: 10s

# ============================================
# ENERGY COUNTERS - DAILY
# ============================================

  # Today AC Production (Address 53-54)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 53
    name: "Today AC Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Today PV Production (Address 1149-1150)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1149
    name: "Today PV Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Today Load Energy from Inverter (Address 1060-1061)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1060
    name: "Today Inverter to Load Energy"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Today Grid Import Energy (Address 1044-1045)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1044
    name: "Today Grid Import"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Today Grid Export Energy (Address 1048-1049)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1048
    name: "Today Grid Export"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Today Battery Charge (Address 1056-1057)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1056
    name: "Today Battery Charge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Today Battery Discharge (Address 1052-1053)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1052
    name: "Today Battery Discharge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

# ============================================
# ENERGY COUNTERS - LIFETIME
# ============================================

  # Total AC Production (Address 55-56)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 55
    name: "Total AC Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Total PV Production (Address 91-92)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 91
    name: "Total PV Production"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Total Inverter to Load Energy (Address 1046-1047)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1046
    name: "Total Grid Import"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Total Grid Export (Address 1050-1051)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1050
    name: "Total Grid Export"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Total Battery Charge (Address 1058-1059)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1058
    name: "Total Battery Charge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

  # Total Battery Discharge (Address 1054-1055)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 1054
    name: "Total Battery Discharge"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 5
    filters:
      - multiply: 0.1

# ============================================
# RUNTIME
# ============================================

  # Total Runtime (Address 57-58)
  - platform: modbus_controller
    modbus_controller_id: growatt_sph
    address: 57
    name: "Total Runtime"
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "h"
    device_class: duration
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: 10
    filters:
      - multiply: 0.5  # Convert 0.5s to seconds
      - lambda: return x / 3600.0;  # Convert seconds to hours

# ============================================
# PV STRING ENERGY COUNTERS (Optional)
# ============================================
# Uncomment if you want per-string energy tracking

  # # PV1 Today Energy (Address 59-60)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 59
  #   name: "PV1 Today Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: 5
  #   filters:
  #     - multiply: 0.1

  # # PV1 Total Energy (Address 61-62)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 61
  #   name: "PV1 Total Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: 5
  #   filters:
  #     - multiply: 0.1

  # # PV2 Today Energy (Address 63-64)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 63
  #   name: "PV2 Today Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: 5
  #   filters:
  #     - multiply: 0.1

  # # PV2 Total Energy (Address 65-66)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 65
  #   name: "PV2 Total Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: 5
  #   filters:
  #     - multiply: 0.1

  # # PV3 Today Energy (Address 67-68)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 67
  #   name: "PV3 Today Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: 5
  #   filters:
  #     - multiply: 0.1

  # # PV3 Total Energy (Address 69-70)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt_sph
  #   address: 69
  #   name: "PV3 Total Energy"
  #   register_type: read
  #   value_type: U_DWORD
  #   unit_of_measurement: "kWh"
  #   device_class: energy
  #   state_class: total_increasing
  #   accuracy_decimals: 1
  #   skip_updates: 5
  #   filters:
  #     - multiply: 0.1

